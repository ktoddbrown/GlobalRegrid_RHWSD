---
title: "Processing HWSD in R to generate global maps"
author: "K Todd-Brown (ktoddbrown@gmail.com)"
date: "April 14 2021"
output: html_document
---

Soil carbon values extracted from the Harmonized World Soil Database are at too fine a resolution to work with for most global analysis. This repository goes through and regrids the soil organic carbon and bulk density maps from the HWSD to a 1x1 degree resolution using R. An additional regridded version of HWSD can be found http://daac.ornl.gov/SOILS/guides/HWSD.html (unrelated to this repo) and there is a R package that can be found here https://github.com/dlebauer/rhwsd (also unrelated to this repo).

This work was based off of Rossiter, D. G. (2012). Processing the Harmonized World Soil Database (Version 1.2) in R. Institute of Soil Science, Chinese Academy of Sciences.

These scripts will download and set up the libraries.

First let's set up the libraries.
```{r setUp}
library(tidyverse)
library(Hmisc)
library(raster)

source('R/accessHWSD.R')
source('R/makeSOC.R')

```

First read in the raster that gives the soil identifier for each grid point.
```{r loadRaster, warning=FALSE}
HWSD <- accessHWSD(downloadFolder = 'temp')

map_lowres <- raster::aggregate(HWSD$raster, fact = 120, fun = modal)
soc_map <- makeSOC(map_lowres, HWSD$db, verbose=TRUE)
#soc_map <- makeSOC(HWSD$raster, HWSD$db, verbose=TRUE)

gridSize <- as.data.frame(area(soc_map), xy = TRUE) %>% 
  rename('grid_area_km2' = 'layer')
```



```{r}
data.df <- as.data.frame(soc_map, xy=TRUE) %>%
  full_join(gridSize, by = c('x', 'y'))

ggplot(data.df) +
  geom_raster(aes(x=x, y=y, fill=hwsd_SOC_top.kg_per_m2)) +
  guides(fill = guide_legend(title = "SOC, 0-30cm [kg m-2]"))

ggplot(data.df) +
  geom_raster(aes(x=x, y=y, fill=hwsd_SOC_sub.kg_per_m2)) +
  guides(fill = guide_legend(title = "SOC, 30-100cm [kg m-2]"))

ggplot(data.df) +
  geom_raster(aes(x=x, y=y, fill=hwsd_SOC_top.kg_per_m2 + hwsd_SOC_sub.kg_per_m2)) +
  guides(fill = guide_legend(title = "SOC, 0-100cm [kg m-2]"))
```

```{r}

sum(data.df$grid_area_km2*(data.df$hwsd_SOC_sub.kg_per_m2 + data.df$hwsd_SOC_top.kg_per_m2)*(1e6/1e12), na.rm=TRUE)

```
